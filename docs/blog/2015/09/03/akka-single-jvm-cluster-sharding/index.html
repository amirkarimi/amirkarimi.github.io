<!doctype html>
<html lang="en" class="h-100">

<head>
    

    <title>Amir Karimi - Blog - Akka: Integration Tests for Single Node Cluster Sharding</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="/assets/css/main.css?v=2" rel="stylesheet">
    <link href="/assets/css/highlight.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css">
    
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-38DSNZVGYF"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-38DSNZVGYF');
        </script>
    
    



    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="d-flex flex-column h-100">

    <!-- Begin page content -->
    
<nav class="navbar navbar-expand-lg bg-light mb-4">
    <div class="container">
        <a class="navbar-brand" href="https://amirkarimi.dev">Amir Karimi</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/about" >
                            About
                        </a>
                    </li>
                
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/blog" >
                            Blog
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</nav>

<main class="flex-grow-1">
    <div class="container">
        
<div class="row gx-5 page">
    
    <div class="col-lg-3 order-lg-3 mb-1">
        <div class="page-toc">
            <h6>On this page</h6>
            <hr class="my-2"/>
            
        <ul>
        
            <li>
                <a href="#solution">Solution</a>
                
            </li>
        
        </ul>
    
        </div>
    </div>
    
    <div class="col-lg-9">
        <h1 class="text-2xl font-bold mb-3">Akka: Integration Tests for Single Node Cluster Sharding</h1>
        <div class="font-normal">
            <p><a href="https://github.com/typesafehub/activator-akka-cluster-sharding-scala/tree/master/src/multi-jvm/scala/sample/blog">Multi-JVM tests</a> are the default way of testing an Akka cluster sharding application. But sometimes you just need the sharding functionality where multi-JVM tests are just overkill. I didn't find any sample or guide describing the best practices for this situation.</p>
<!--more-->

<p>I just found out that it's not a bad idea to use Akka cluster sharding even if you don't need the real clustering features. But if you follow the default recommended way of integration tests you will ended up with the multi-jvm tests which are rather slow and complicated.</p>
<p>Another issue with the cluster sharding tests is the persistence. You have to use in-memory persistence plug-in or tests must not be run in parallel.</p>
<h2 id="solution">Solution</h2>
<p>I've build a simple test kit to be used as a Specs2 scope:</p>
<div class="codehilite"><pre><span></span><code><span class="k">object</span><span class="w"> </span><span class="nc">ClusterTestKit</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">storageLocations</span><span class="p">(</span><span class="n">system</span><span class="p">:</span><span class="w"> </span><span class="nc">ActorSystem</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;akka.persistence.journal.leveldb.dir&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;akka.persistence.journal.leveldb-shared.store.dir&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;akka.persistence.snapshot-store.local.dir&quot;</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">File</span><span class="p">(</span><span class="n">system</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">getString</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">deletePersistenceFiles</span><span class="p">(</span><span class="n">system</span><span class="p">:</span><span class="w"> </span><span class="nc">ActorSystem</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">storageLocations</span><span class="p">(</span><span class="n">system</span><span class="p">).</span><span class="n">foreach</span><span class="p">(</span><span class="n">dir</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">FileUtils</span><span class="p">.</span><span class="n">deleteDirectory</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IsolatedCluster</span><span class="p">(</span><span class="n">_system</span><span class="p">:</span><span class="w"> </span><span class="nc">ActorSystem</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">extends</span><span class="w"> </span><span class="nc">TestKit</span><span class="p">(</span><span class="n">_system</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">DefaultTimeout</span><span class="w"></span>
<span class="w">  </span><span class="k">with</span><span class="w"> </span><span class="nc">Around</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">ImplicitSender</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nc">ClusterTestKit</span><span class="p">.</span><span class="n">_</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">this</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">this</span><span class="p">(</span><span class="nc">TestActorSystemManager</span><span class="p">.</span><span class="n">getSystem</span><span class="p">(</span><span class="n">tempPersistence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">around</span><span class="p">[</span><span class="nc">T</span><span class="p">:</span><span class="w"> </span><span class="nc">AsResult</span><span class="p">](</span><span class="n">t</span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">T</span><span class="p">):</span><span class="w"> </span><span class="nc">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nc">AsResult</span><span class="p">.</span><span class="n">effectively</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nc">TestKit</span><span class="p">.</span><span class="n">shutdownActorSystem</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">deletePersistenceFiles</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p><code>IsolatedCluster</code> class provides an isolated actor system cluster which makes tests easier. It also removes the persistence files.</p>
<p>As you can see <code>TestActorSystemManager</code> is the responsible for building the actor system and setting up cluster sharding with a single node:</p>
<div class="codehilite"><pre><span></span><code><span class="k">object</span><span class="w"> </span><span class="nc">TestActorSystemManager</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getSystem</span><span class="p">(</span><span class="n">tempPersistence</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSystemWithoutSharding</span><span class="p">(</span><span class="n">tempPersistence</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">setupSharding</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">system</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">getSystemWithoutSharding</span><span class="p">(</span><span class="n">tempPersistence</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pathPrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tempPersistence</span><span class="p">)</span><span class="w"> </span><span class="nc">Random</span><span class="p">.</span><span class="n">alphanumeric</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="n">mkString</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ConfigFactory</span><span class="p">.</span><span class="n">parseString</span><span class="p">(</span><span class="s">s&quot;&quot;&quot;</span>
<span class="s">      akka {</span>
<span class="s">        loglevel = &quot;INFO&quot;</span>

<span class="s">        cluster.metrics.enabled=off</span>
<span class="s">        actor.provider = &quot;akka.cluster.ClusterActorRefProvider&quot;</span>

<span class="s">        persistence.journal.leveldb {</span>
<span class="s">          native = off</span>
<span class="s">          dir = &quot;target/</span><span class="si">${</span><span class="n">pathPrefix</span><span class="si">}</span><span class="s">-journal&quot;</span>
<span class="s">        }</span>

<span class="s">        remote {</span>
<span class="s">          log-remote-lifecycle-events = off</span>
<span class="s">          netty.tcp {</span>
<span class="s">            hostname = &quot;127.0.0.1&quot;</span>
<span class="s">            port = 0</span>
<span class="s">          }</span>
<span class="s">        }</span>

<span class="s">        persistence.snapshot-store.plugin = &quot;akka.persistence.snapshot-store.local&quot;</span>
<span class="s">        persistence.snapshot-store.local.dir = &quot;target/</span><span class="si">${</span><span class="n">pathPrefix</span><span class="si">}</span><span class="s">-snapshots&quot;</span>
<span class="s">      }</span>
<span class="s">    &quot;&quot;&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="nc">ActorSystem</span><span class="p">(</span><span class="nc">ActorSystemManager</span><span class="p">.</span><span class="nc">SystemName</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">setupSharding</span><span class="p">(</span><span class="n">system</span><span class="p">:</span><span class="w"> </span><span class="nc">ActorSystem</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Join cluster</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Cluster</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">cluster</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster</span><span class="p">.</span><span class="n">selfAddress</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Start sharding</span>
<span class="w">    </span><span class="nc">ActorSystemManager</span><span class="p">.</span><span class="n">startSharding</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Note that I didn't use in-memory persistence plugin. Instead, the path of snapshots and journal stores are set randomly which allows tests to be run in parallel while I keep the production persistence plugin.</p>
<p>This made the tests over 400% faster.</p>
<p>And here is the integration test:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SampleActorSpec</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Specification</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">Matchers</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;Sample actor&quot;</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;send back info&quot;</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">IsolatedCluster</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">sampleRegion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClusterSharding</span><span class="p">(</span><span class="n">system</span><span class="p">).</span><span class="n">shardRegion</span><span class="p">(</span><span class="nc">SampleActor</span><span class="p">.</span><span class="n">shardName</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">sampleRegion</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nc">GetInfo</span><span class="p">(</span><span class="s">&quot;actor1&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">expectMsg</span><span class="p">(</span><span class="nc">SampleInfo</span><span class="p">(</span><span class="s">&quot;actor1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">SampleActorState</span><span class="p">()))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Everything is like the default cluster sharding samples except that we have a single node. This way we can start simple and increase the node numbers and even scale-out the system, when necessary.</p>
        </div>
        
        <div class="mt-5 mb-4 gap-2 d-flex justify-content-between">
            
            <a class="btn btn-outline-secondary" href="/blog/2015/08/27/how-i-deploy-my-play-apps">
                <span aria-hidden="true">&laquo;</span>
                How I Deploy My Play! Apps
            </a>
            
            
            <a class="btn btn-outline-secondary" href="/blog/2015/10/11/non-verbose-seo-friendly-localization-play-framework">
                Non-verbose SEO friendly internationalization for ...
                <span aria-hidden="true">&raquo;</span>
            </a>                
            
        </div>
        
    </div>
</div>

    </div>
</main>


    <footer class="footer mt-auto py-3">
        
        <div class="container d-flex flex-wrap justify-content-between">
            <div>
                <span class="mb-3 mb-md-0 text-muted">
                    &copy; 2023
                    <a href="https://amirkarimi.dev" class="text-muted">Amir Karimi</a>.
                    All Rights Reserved.
                </span>
            </div>

            
            <div>
                <div class="hstack gap-2 social-icons">
    <a href="https://twitter.com/4m1rk">
        <svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/amirkarimi">
        <svg role="img"  width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
    </a>
    <a href="https://github.com/amirkarimi">
        <svg role="img"  width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
    </a>
</div>
            </div>
            
        </div>
    </footer>

    <!-- Bootstrap JavaScript Libraries -->
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
</body>
</html>